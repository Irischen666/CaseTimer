<head>
  <style>
   .row{
     text-align: center;
   }
  </style>
</head>

<body>
  <div class="row">
    <h1 style="text-align: center"> Rails 101 </h1>
  </div>

  <div class="row">
    <div class="col-md-10">
      <div class="progress">
        <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="50"
        aria-valuemin="0" aria-valuemax="100" style="width:100%">
          100% Complete (info)
        </div>
      </div>

      <div class="progress">
        <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="60"
        aria-valuemin="0" aria-valuemax="100" style="width:60%">
          60% Complete (warning)
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-10">
        <div class="container">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>步骤</th>
                  <th>步骤描述</th>
                  <th>步骤计时</th>
                  <th>计时</th>
                </tr>
              </thead>
              <tbody>
                <% @tasks.each do |task| %>
                    <tr>
                      <td><%= task.title %></td>
                      <td><%= task.description %></td>
                      <% if task.practice_time.present? %>
                        <td><span id="timer_label_<%= task.id %>"><%= task.practice_time_str %></span></td>
                        <td></td>
                      <% else %>
                        <td><span id="timer_label_<%= task.id %>"></span></td>
                        <td>
                          <%= button_tag('开始', id:"my_start_btn_#{task.id}", class: "btn btn-info") %>
                          <%= link_to "停止", update_timer_case_path(@case), id:"my_stop_btn_#{task.id}", class: "btn btn-danger" %>
                        </td>
                      <% end %>
                    </tr>
                <% end %>

              </tbody>
            </table>
        </div>
      </div>
  </div>

  <div row>
    <div class="col-md-offset-10">
      <button type="button" class="btn btn-danger">当前总用时</button>
    </div>
  </div>
</body>

<h3>Timer</h3>
<p id="demo"></p>
<div id="myStartTime"></div>
<div id="myStopTime"></div>
<button onclick="myStartFunction()">开始</button>
<button onclick="myStopFunction()" >结束</button>
<%= link_to "停止", update_timer_case_path(@case), id:"my_stop_btn" %>


<script>

var countUpDate
var x
var distance
var task_index

function myTimer() {
  var now = new Date().getTime();
  var k = Math.floor(Date.now() / 1000);
  console.log(k);
  distance = now - countUpDate;

  var days = Math.floor(distance / (1000 * 60 * 60 * 24));
  var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  var seconds = Math.floor((distance % (1000 * 60)) / 1000);

  document.getElementById("timer_label_"+task_index).innerHTML = hours + "小时 "
  + minutes + "分 " + seconds + "秒 ";
  console.log(task_index)
}

$('[id^="my_start_btn_"').on('click', function(){
    countUpDate = new Date();
    console.log($(this).attr('id'))
    task_index = $(this).attr('id').replace( /\D+/g, '');
    x = setInterval(function(){myTimer()}, 1000);
    console.log(11)
})

$('[id^="my_stop_btn_"]').on('click', function(evt){
  evt.preventDefault();
  clearInterval(x);
  var url = $(this).attr("href")
  console.log(url)

  $.ajax({
    url: url,
    method: "POST",
    beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
    dataType: "json",
    data: {
      practice_time: distance,
      task_id: parseInt(task_index)
    },
    success: function(data){
      var practice_time = data["practice_time"];
      $("#timer_label_"+task_index).replaceWith('<span id="timer_label_' + data["task_id"] + '">' + practice_time + '</span>');
    }
  })

  distance = 0;
})


function myStopFunction() {
  clearInterval(x);
  distance = 0;
  document.getElementById("demo").innerHTML = 0 + "小时 "
  + 0 + "分 " + 0 + "秒 ";
}

function myStartFunction() {

  countUpDate = new Date();
  x = setInterval(function(){myTimer()}, 1000);
}


</script>
